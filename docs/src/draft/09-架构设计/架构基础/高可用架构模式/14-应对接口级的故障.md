> <<从0开始学架构>> 学习笔记Day14：应对接口级的故障
> 

接口级故障的典型表现就是，系统并没有宕机、网络也没有中断，但业务却出现问题了，例如业务响应缓慢、大量访问超时和大量访问出现异常（给用户弹出提示“无法连接数据库”）。这类问题的主要原因在于系统压力太大、负载太高，导致无法快速处理业务请求，由此引发更多的后续问题。最常见的情况就是，数据库慢查询将数据库的服务器资源耗尽，导致读写超时，业务读写数据库时要么无法连接数据库、要么超时，最终用户看到的现象就是访问很慢，一会儿访问抛出异常，一会儿访问又是正常结果。

接口级故障的原因可以分为两大类：

- 内部原因：包括程序 bug 导致死循环，某个接口导致数据库慢查询，程序逻辑不完善导致耗尽内存等。
- 外部原因：包括黑客攻击，促销或者抢购引入了超出平时几倍甚至几十倍的用户，第三方系统大量请求，第三方系统响应缓慢等。


解决接口级故障的核心思想和异地多活基本类似，都是优先保证核心业务和优先保证绝大部分用户。常见的应对方法有四种，降级、熔断、限流和排队


### 降级

降级指系统将某些业务或者接口的功能降低，可以是只提供部分功能，也可以是完全停掉所有功能。降级的目的是应对系统自身的故障

### 熔断

熔断是指按照规则停掉外部接口的访问，防止某些外部接口故障导致自己的系统处理能力急剧下降或者出故障。熔断的目的是应对依赖的外部系统故障的情况。

实现熔断机制有两个关键点：

- 需要有一个统一的 API 调用层，由 API 调用层来进行采样或者统计。如果接口调用散落在代码各处，就没法进行统一处理了。
- 阈值的设计，例如 1 分钟内 30% 的请求响应时间超过 1 秒就熔断，这个策略中的“1 分钟”“30%”“1 秒”都对最终的熔断效果有影响。实践中，一般都是先根据分析确定阈值，然后上线观察效果，再进行调优。

### 限流

降级是从系统功能优先级的角度考虑如何应对故障，而限流则是从用户访问压力的角度来考虑如何应对故障。限流指只允许系统能够承受的访问量进来，超出系统访问能力的请求将被丢弃。

限流一般都是系统内实现的，常见的限流方式可以分为两类：基于请求限流和基于资源限流

**基于请求限流**

基于请求限流是从系统外部考虑的

第一种是限制总量，也就是限制某个指标的累积上限
第二种是限制时间量，也就是限制一段时间内某个指标的上限

**基于资源限流**

基于资源限流是从系统内部考虑的

找到系统内部影响性能的关键资源，对其使用上限进行限制。常见的内部资源包括CPU负载、连接数、文件句柄、线程数和请求队列等

**限流算法**

为了更好地实现前面描述的各种限流方式，通常情况下我们会基于限流算法来设计方案。常见的限流算法有两大类四小类，它们的实现原理和优缺点各不相同，在实际设计的时候需要根据业务场景来选择。

1. 时间窗-固定时间窗

固定时间窗算法的实现原理是，统计固定时间周期内的请求量或者资源消耗量，超过限额就会启动限流，如下图所示：

![](https://static001.geekbang.org/resource/image/55/13/55df7cc26d23c462131b7c7b7cfd9813.png?wh=1386x510)

2. 时间窗-滑动时间窗

为了解决临界点问题，滑动时间窗算法应运而生，它的实现原理是，两个统计周期部分重叠，从而避免短时间内的两个统计点分属不同的时间窗的情况，如下图所示：

![](https://static001.geekbang.org/resource/image/c9/a6/c95c31d64ae5c691c77a8ce7c5fa60a6.png?wh=1394x482)

总体上来看，滑动时间窗的限流效果要比固定时间窗更好，但是实现也会稍微复杂一些。

3. 桶算法-漏桶

将请求放入“桶”（消息队列等），业务处理单元（线程、进程和应用等）从桶里拿请求处理，桶满则丢弃新的请求

![](https://static001.geekbang.org/resource/image/05/67/056aa8b560f02926911c91803f5cda67.jpg?wh=1920x1080)

漏桶算法的技术本质是总量控制，桶大小是设计关键

漏桶算法主要适用于瞬时高并发流量的场景（例如刚才提到的 0 点签到、整点秒杀等）。在短短几分钟内涌入大量请求时，为了更好的业务效果和用户体验，即使处理慢一些，也要做到尽量**不丢弃用户请求**


4. 桶算法-令牌桶算法

桶中放入的不是请求，而是“令牌”，这个令牌就是业务处理前需要拿到的“许可证”。也就是说，当系统收到一个请求时，先要到令牌桶里面拿“令牌”，拿到令牌才能进一步处理，**拿不到就要丢弃请求**

![](https://static001.geekbang.org/resource/image/78/b2/7862d045e4e332e8d6f3fd1250b429b2.jpg?wh=1920x1080)

令牌桶算法的技术本质是速率控制，令牌产生的速率是设计关键

令牌桶算法主要适用于两种典型的场景，一种是需要控制访问第三方服务的速度，防止把下游压垮，例如支付宝需要控制访问银行接口的速率；另一种是需要控制自己的处理速度，防止过载，例如压测结果显示系统最大处理 TPS 是 100，那么就可以用令牌桶来限制最大的处理速度。

### 排队

排队实际上是限流的一个变种，限流是直接拒绝用户，排队是让用户等待一段时间，全世界最有名的排队当属 12306 网站排队了。

由于排队需要临时缓存大量的业务请求，单个系统内部无法缓存这么多数据，一般情况下，排队需要用独立的系统去实现，例如使用 Kafka 这类消息队列来缓存用户请求。


# 总结

![](https://static001.geekbang.org/resource/image/24/c6/2480b6166c3e01048ded3c24be6259c6.jpg?wh=1920x1001)